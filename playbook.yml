---
- name: Deploy Amazin Web Stack (LAMP)
  hosts: targets
  become: yes

  vars_files:
    - vars/main.yml

  tasks:
    # --- 1. System & Package Setup ---
    - name: Install Apache, MySQL, PHP, and dependencies
      apt:
        name:
          - apache2
          - mysql-server
          - php
          - libapache2-mod-php
          - php-mysql
          - python3-mysqldb
          - unzip
          - git
        state: present
        update_cache: yes
        cache_valid_time: 3600

    # --- 2. Apache & Web App Setup ---
    - name: Create web root directory
      file:
        path: "{{ amazin_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Deploy PHP application code
      copy:
        src: files/amazin.php
        dest: "{{ amazin_root }}/index.php"
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Configure Apache virtual host
      template:
        src: templates/vhost.conf.j2
        dest: /etc/apache2/sites-available/amazin.conf
        mode: '0644'
      notify: restart apache

    - name: Enable new site and disable default site
      shell: |
        a2dissite 000-default.conf
        a2ensite amazin.conf
      register: site_config
      changed_when: "'Enabling site' in site_config.stdout or 'Site 000-default disabled' in site_config.stdout"
      notify: restart apache

    # --- 3. MySQL Database Security ---
    - name: Ensure MySQL is running
      systemd:
        name: mysql
        state: started
        enabled: yes

    - name: Configure .my.cnf for root authentication
      copy:
        content: |
          [client]
          user=root
          password={{ db_root_password }}
        dest: /root/.my.cnf
        owner: root
        mode: '0600'

    - name: Secure MySQL root user and remove remote access
      mysql_user:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: root
        password: "{{ db_root_password }}"
        host: "{{ item }}"
        state: present
      with_items:
        - localhost
        - 127.0.0.1
        - ::1

    - name: Remove the MySQL test database
      mysql_db:
        name: test
        state: absent

    # Optional: Deleting my cnf for security if needed
    # - name: Delete .my.cnf
    #   file:
    #     path: /root/.my.cnf
    #     state: absent
    # --- 4. Database Setup & Seeding ---
    - name: Create the amazin database
      mysql_db:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: amazin_db
        state: present

    - name: Create a dedicated database user for the web app
      mysql_user:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: amazin_user
        password: "insecure_db_password"
        priv: "amazin_db.*:ALL"
        host: localhost
        state: present

    - name: Create database seed script
      copy:
        dest: /tmp/seed_amazin.sql
        content: |
          -- Drop tables if they exist to ensure a clean reset
          DROP TABLE IF EXISTS users;
          DROP TABLE IF EXISTS products;

          -- Create Users Table
          CREATE TABLE users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              username VARCHAR(50) NOT NULL,
              password VARCHAR(255) NOT NULL,
              role VARCHAR(20) DEFAULT 'user'
          );

          -- Create Products Table
          CREATE TABLE products (
              id INT AUTO_INCREMENT PRIMARY KEY,
              name VARCHAR(100) NOT NULL,
              description TEXT,
              price DECIMAL(10, 2)
          );

          -- Insert Dummy Users (Includes a juicy target for attackers)
          INSERT INTO users (username, password, role) VALUES
          ('admin', 'SuperSecretAdmin123!', 'admin'),
          ('jsmith', 'password123', 'user'),
          ('bwayne', 'batman', 'user');

          -- Insert Dummy Products (Includes a flag for the CTF)
          INSERT INTO products (name, description, price) VALUES
          ('Wireless Mouse', 'A standard ergonomic mouse.', 19.99),
          ('Mechanical Keyboard', 'Clicky switches for faster typing.', 89.50),
          ('Flag', 'FLAG{sql_1nj3ct10n_s1r3n}', 9999.99),
          ('Coffee Mug', 'Holds liquid energy.', 12.00);
        owner: root
        group: root
        mode: '0600'

    - name: Import dummy data into the database
      mysql_db:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        name: amazin_db
        state: import
        target: /tmp/seed_amazin.sql

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted

